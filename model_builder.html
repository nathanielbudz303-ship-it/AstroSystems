<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Astra Model Assembler</title>
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <style>
        body {
            background: #020617;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: monospace;
        }

        button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        #status {
            margin-top: 1rem;
            color: #94a3b8;
        }
    </style>
</head>

<body>
    <h1>Astra Model Assembler</h1>
    <p>Click below to combine the geometry and download the full .glb file.</p>
    <button id="process-btn">Generate & Download Full Model</button>
    <div id="status">Ready...</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        const btn = document.getElementById('process-btn');
        const status = document.getElementById('status');

        btn.addEventListener('click', async () => {
            btn.disabled = true;
            status.textContent = "Loading dependencies...";

            try {
                // 1. Setup Loaders
                const dracoLoader = new DRACOLoader();
                dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');

                const loader = new GLTFLoader();
                loader.setDRACOLoader(dracoLoader);

                // 2. Load Model
                status.textContent = "Loading HalfFoil.glb...";

                loader.load('assets/models/HalfFoil.glb', (gltf) => {
                    status.textContent = "Processing geometry...";

                    const originalModel = gltf.scene;
                    const mirroredModel = originalModel.clone();

                    // --- REPLICATE LOGIC FROM MAIN SITE ---
                    // Calculate Center
                    const box = new THREE.Box3().setFromObject(originalModel);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    const fullRingWrapper = new THREE.Group();
                    fullRingWrapper.name = "Astra_Full_Assembly";

                    // Center & Add Original
                    originalModel.position.sub(center);
                    fullRingWrapper.add(originalModel);

                    // Center, Mirror & Add Clone
                    mirroredModel.position.sub(center);
                    mirroredModel.scale.set(1, 1, -1); // Mirror Z
                    fullRingWrapper.add(mirroredModel);

                    // Orientation Fix (Stand Upright)
                    // The user requested a tilt in the preview, but for the raw FILE download, 
                    // it is usually best to export "flat" or upright. 
                    // Let's stick to the main upright orientation (Rotate X 90 degrees) 
                    // so it imports cleanly into Blender/Unity/etc.
                    // If they want the tilt baked in, we can change this.
                    // Let's create a parent container to hold the rotation
                    const exportContainer = new THREE.Group();
                    exportContainer.add(fullRingWrapper);

                    // Apply the base rotation to make it upright (Ring vertical)
                    fullRingWrapper.rotation.x = Math.PI / 2;

                    status.textContent = "Exporting to .GLB...";

                    // 3. Export
                    const exporter = new GLTFExporter();
                    exporter.parse(
                        exportContainer,
                        function (result) {
                            saveArrayBuffer(result, 'Astra_Full_Model.glb');
                            status.textContent = "Download started!";
                            btn.disabled = false;
                        },
                        function (error) {
                            console.error(error);
                            status.textContent = "Export Error: " + error.message;
                            btn.disabled = false;
                        },
                        { binary: true } // Export as .glb
                    );

                }, undefined, (err) => {
                    console.error(err);
                    status.textContent = "Load Error: " + err.message;
                    btn.disabled = false;
                });

            } catch (e) {
                console.error(e);
                status.textContent = "Critical Error: " + e.message;
                btn.disabled = false;
            }
        });

        function saveArrayBuffer(buffer, filename) {
            save(new Blob([buffer], { type: 'application/octet-stream' }), filename);
        }

        function save(blob, filename) {
            const link = document.createElement('a');
            link.style.display = 'none';
            document.body.appendChild(link);
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>

</html>